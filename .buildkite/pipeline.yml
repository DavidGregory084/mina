steps:
  - label: ":gradle: Continuous Integration"
    command: "./.buildkite/ci.sh"
    artifact_paths: "**/build/test-results/*/TEST-*.xml"
    plugins:
      - cache#v1.0.0:
          backend: s3
          compression: tgz
          path: .gradle
          restore: branch
          save: branch
      - cache#v1.0.0:
          backend: s3
          compression: tgz
          path: vscode-plugin/node_modules
          manifest: vscode-plugin/package-lock.json
          restore: file
          save: file
      - docker#v5.11.0:
          image: "timbru31/java-node:17-jdk-16"
          memory: 3g

  - wait: ~
    continue_on_failure: true

  - label: ":junit: Collect JUnit Results"
    plugins:
      - junit-annotate#v2.4.1:
          artifacts: "**/build/test-results/*/TEST-*.xml"

  - label: ":test-analytics: Test Analytics"
    command: buildkite-agent artifact download "**/build/test-results/*/TEST-*.xml" .
    plugins:
      - test-collector#v1.10.1:
          files: "**/build/test-results/*/TEST-*.xml"
          format: "junit"
